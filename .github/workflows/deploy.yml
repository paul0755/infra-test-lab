name: Deploy Backend

# ğŸš€ deploy ë¸Œëœì¹˜ë¡œ pushë  ë•Œë§ˆë‹¤ CI/CD ìë™ ì‹¤í–‰
on:
  push:
    branches:
      - deploy

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # GitHub Actionsê°€ ì‹¤í–‰ë˜ëŠ” ê°€ìƒë¨¸ì‹  í™˜ê²½

    steps:
      # 1ï¸âƒ£ ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3ï¸âƒ£ gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4ï¸âƒ£ í…ŒìŠ¤íŠ¸ ìƒëµí•˜ê³  Spring Boot Jar ë¹Œë“œ
      - name: Build without tests
        run: ./gradlew bootJar -x test

      # 5ï¸âƒ£ AWS ì ‘ê·¼ì„ ìœ„í•œ ì•¡ì„¸ìŠ¤ í‚¤/ì‹œí¬ë¦¿ í‚¤ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 6ï¸âƒ£ ECR ë¡œê·¸ì¸ â†’ Docker Push ê¶Œí•œ íšë“
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ + ECRì— Push
      - name: Build and push Docker image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ${{ steps.login-ecr.outputs.registry }}/techpost-backend:latest \
            --push \
            .

      # 8ï¸âƒ£ EC2ì— SSH ì ‘ì† í›„ deploy.sh ì‹¤í–‰ â†’ ìë™ ë°°í¬
      - name: Deploy to EC2 using SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}       # EC2 í¼ë¸”ë¦­ IP
          username: ubuntu                    # EC2 ê¸°ë³¸ ìœ ì €
          key: ${{ secrets.EC2_SSH_KEY }}     # GitHub Secretsì— ì €ì¥ëœ PEM í‚¤
          script: |
            cd /home/ubuntu
            chmod +x deploy.sh                # deploy.sh ì‹¤í–‰ ê¶Œí•œ ë³´ì¥
            ./deploy.sh                       # ğŸ”¥ ìë™ ë°°í¬ ì‹¤í–‰
